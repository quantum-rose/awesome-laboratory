<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <meta name="format-detection" content="telephone=no" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>异形轮播图——旋转木马</title>
        <style>
            :root {
                font-size: calc(100vw / 7.5);
                --swiper-item-width: 3; /* 轮播图一个单元的宽度，单位 rem */
            }

            * {
                margin: 0;
                padding: 0;
            }

            html,
            body {
                height: 100%;
                overflow: hidden;
            }

            .swiper {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate3d(-50%, -50%, 0);
                transform-style: preserve-3d;
                perspective: calc(var(--swiper-item-width) * 3rem);
            }

            .swiper-item {
                position: absolute;
                width: calc(var(--swiper-item-width) * 1rem);
                height: calc(var(--swiper-item-width) * 4rem / 5);
            }
        </style>
    </head>
    <body>
        <div class="swiper"></div>
        <script src="https://cdn.staticfile.org/vConsole/3.3.4/vconsole.min.js"></script>
        <script>
            new VConsole();
            (function(window, document) {
                let swiperItemWidth =
                    getComputedStyle(document.documentElement)
                        .getPropertyValue('--swiper-item-width')
                        .trim() - 0;
                let swiper = document.querySelector('.swiper');
                let swiperTouchstartPoint = null;
                let swiperTouchendPoint = null;
                let swiperItems = [
                    {
                        id: 0,
                        bgColor: 'pink',
                        deg: 0,
                        isCurrent: false
                    },
                    {
                        id: 1,
                        bgColor: 'cyan',
                        deg: 0,
                        isCurrent: false
                    },
                    {
                        id: 2,
                        bgColor: 'skyblue',
                        deg: 0,
                        isCurrent: false
                    },
                    {
                        id: 3,
                        bgColor: 'hotpink',
                        deg: 0,
                        isCurrent: false
                    },
                    {
                        id: 4,
                        bgColor: 'lightgreen',
                        deg: 0,
                        isCurrent: false
                    }
                ];
                let swiperItemTranslateZ = `calc(var(--swiper-item-width) * 1rem / ${2 *
                    Math.sin((2 * Math.PI) / swiperItems.length)})`; // 轮播图单元的 translateZ，其值为正 n 边形外接圆的半径，n 为轮播图单元数量
                let swiperItemGapDeg = 360 / swiperItems.length; // 相邻两个轮播图单元的 rotateY 之差
                let halfSwiperItemGapDeg = swiperItemGapDeg / 2;
                let swiperTransitionDuration = 0.3;

                /* 初始化 */
                swiperItems.forEach((item, index) => {
                    let swiperItem = document.createElement('div');
                    swiperItem.classList.add('swiper-item');
                    swiperItem.style.backgroundColor = item.bgColor;

                    item.deg = swiperItemGapDeg * index;
                    item.isCurrent = index === 0;
                    item.elem = swiperItem;
                    swiper.appendChild(swiperItem);
                });

                animateSwiper(0, 0);

                swiper.addEventListener('touchstart', function(e) {
                    swiperTouchstartPoint = swiperTouchendPoint = e.targetTouches[0];
                });

                swiper.addEventListener('touchmove', function(e) {
                    let deltaDeg = (e.targetTouches[0].pageX - swiperTouchendPoint.pageX) / 2;
                    animateSwiper(deltaDeg, 0);
                    swiperTouchendPoint = e.targetTouches[0];
                });

                swiper.addEventListener('touchend', function(e) {
                    let deltaX = swiperTouchendPoint.pageX - swiperTouchstartPoint.pageX;
                    let sample = swiperItems[0];
                    let degFloor = Math.floor(sample.deg / swiperItemGapDeg) * swiperItemGapDeg;
                    let degCeil = Math.ceil(sample.deg / swiperItemGapDeg) * swiperItemGapDeg;
                    let degTarget = degCeil - sample.deg < sample.deg - degFloor ? degCeil : degFloor;
                    animateSwiper(degTarget - sample.deg, 0.3);
                });

                /**
                 * 轮播图动画
                 * @param {Number} deltaDeg 轮播图要转过的角度
                 * @param {Number} swiperTransitionDuration 动画持续时间 单位秒
                 * @param {Function} callBack 回调函数，包含一个参数为当前的轮播图单元
                 */
                function animateSwiper(deltaDeg, swiperTransitionDuration, callBack = null) {
                    let currentSwiperItem = null;

                    swiperItems.forEach(item => {
                        item.deg += deltaDeg;

                        let degMod360 = item.deg % 360;
                        item.isCurrent =
                            degMod360 < halfSwiperItemGapDeg - 360 ||
                            (degMod360 < halfSwiperItemGapDeg && degMod360 >= -halfSwiperItemGapDeg) ||
                            degMod360 >= 360 - halfSwiperItemGapDeg;
                        item.isCurrent && (currentSwiperItem = item);

                        let style = item.elem.style;
                        style.transform = `translateX(-50%) translateY(-50%) rotateY(${
                            item.deg
                        }deg) translateZ(${swiperItemTranslateZ}) rotateY(${-item.deg}deg)`;
                        style.transitionDuration = `${swiperTransitionDuration}s`;
                    });

                    typeof callBack === 'function' && callBack(currentSwiperItem);
                }
            })(window, document);
        </script>
    </body>
</html>
